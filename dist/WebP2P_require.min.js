
function MessagePacker(e){function t(e,t,r){e.stored=!0;var a={message:e,id:r,timeout:setTimeout(function(){clearTimeout(a.timeout),delete s[t]},BASE_TIMEOUT)};s[t]=a}var r=this,a=0,n={},s={};this.pack=function(t,r){var n=new Array(6),s=t.type;switch(s){case"presence":n[0]=PRESENCE;break;case"offer":n[0]=OFFER;break;case"answer":n[0]=ANSWER;break;default:var c=Error("Unknown message type '"+s+"'");throw c.message=t,c}return n[1]=t.from||e,n.type!=PRESENCE&&(n[2]=t.dest,n[3]=r||a++,n[4]=Math.min(t.ttl||MAX_TTL_DEFAULT,MAX_TTL_DEFAULT),n[5]=t.sdp),n},this.unpack=function(e){var a={},c=e[1],i=e[3],o=e[0];switch(o){case PRESENCE:a.type="presence";break;case OFFER:a.type="offer";break;case ANSWER:a.type="answer";break;default:var u=Error("Unknown message type '"+o+"'");throw u.message=e,u}if(a.from=c,o!=PRESENCE&&(a.dest=e[2],a.ttl=e[4],a.sdp=e[5],a.pack=function(){return r.pack(this,i)}),"offer"==a.type){var f=s[c];if(f){if(f.id>i)return;if(clearTimeout(f.timeout),delete s[c],f.id==i){var e=f.message;return t(e,c,i),e}}else a.reply=function(e,a){var n=r.pack({type:"answer",dest:e,sdp:a},i);return t(n,e,i),n}}if("answer"==a.type){var E=n[c];if(E){var p=E[i];if(p)return p.callback(u,a),void 0}}return a},this.presence=function(){var e=this.pack({type:"presence"});return e},this.offer=function(e,t,r){function a(e,t){s.cancel(),r(e,t)}var s=this.pack({type:"offer",dest:e,sdp:t});if(s.cancel=function(){},r){var c=n[e]=n[e]||{},i=s[3],o=c[i]={message:s,callback:a,timeout:setTimeout(function(){var e=new Error("Timed Out");e.request=s,a(e)},BASE_TIMEOUT)};s.cancel=function(){clearTimeout(o.timeout),delete c[i],Object.keys(c).length||delete n[e]}}return s}}const ERROR=0,PRESENCE=1,OFFER=2,ANSWER=3,MAX_TTL_DEFAULT=5,BASE_TIMEOUT=5e3;module.exports=MessagePacker;
},{}],2:[function(require,module,exports){
function applyChannelsShim(n){function a(n){e.push(n),n.addEventListener("close",function(){e.splice(e.indexOf(n),1)})}if(void 0==n.getDataChannels){var e=[];n.getDataChannels=function(){return e};var t=n.dispatchEvent;n.dispatchEvent=function(n){if("datachannel"==n.type){var e=n.channel;a(e)}t.call(this,n)};var i=n.createDataChannel;n.createDataChannel=function(n,e){var t=i.call(this,n,e);return a(t),t}}}module.exports=applyChannelsShim;
},{}],3:[function(require,module,exports){
function WebP2P(e){function n(e){c.emit("error",new Error(e))}function o(e,n,o){var t=new RTCPeerConnection({iceServers:[{url:"stun:"+l}]},{optional:[{DtlsSrtpKeyAgreement:!0}]});return applyChannelsShim(t),t.addEventListener("icecandidate",function(e){if(!e.candidate){var t=this.localDescription.type,s=this.localDescription.sdp;t==n?o(s):console.error(t+" SDP type is not equal to "+n+" callback type")}}),t.addEventListener("signalingstatechange",function(){"stable"==t.signalingState&&(g.add(e,t),delete v[e],c.emit("peerconnection",t))}),Object.defineProperty(t,"sessionID",{value:e}),t}function t(e,o){o=[c.routingLabel].concat(f,o);for(var t,s=0;t=o[s];s++)e.createDataChannel(t);var r={mandatory:{OfferToReceiveAudio:!1,OfferToReceiveVideo:!1}};e.createOffer(function(o){e.setLocalDescription(o,function(){console.log("["+c.sessionID+"] Offer LocalDescription created and set")},n)},n,r)}function s(e,o){e.setRemoteDescription(new RTCSessionDescription({sdp:o,type:"offer"}),function(){e.createAnswer(function(o){e.setLocalDescription(o,function(){console.log("["+c.sessionID+"] Answer LocalDescription created and set")},n)},n)},n)}function r(e,n){if(--e.ttl<=0)return console.warning("TTL achieved: "+e),void 0;var o=e.dest;e=e.pack();for(var t,s=0;t=g._connectors[s];s++)if(t.sessionID==o)return t.send(e),void 0;g.send(e,n),p.send(e,n)}function i(e){function t(e){var n=g.get(e);if(n)return console.log("["+c.sessionID+"] Already connected to "+e),!0;var o=v[e];if(o){if(console.log("["+c.sessionID+"] Already offered connection to "+e),c.sessionID<e)return!0;o.message.cancel(),o.peerConnection.close(),delete v[e]}return!1}e.on("connected",function(){p.status!=g.status&&c.emit("connected")}),e.on("disconnected",function(){p.status==g.status&&c.emit("disconnected")}),e.on("error",function(e){c.emit("error",e)}),e.on("offer",function(e,n){var i=e.from,a=e.dest;if(i!=c.sessionID)if(a==c.sessionID){if(console.log("["+c.sessionID+"] Received connection request from "+i),t(i))return;var f=e,u=o(i,"answer",function(e){var o=f.reply(i,e);n.send(o)});s(u,e.sdp)}else r(e,n)}),e.on("answer",function(e,o){var t=e.from,s=e.dest;if(t!=c.sessionID)if(s==c.sessionID){console.log("["+c.sessionID+"] Received connection response from "+t);var i=v[t];i?i.peerConnection.setRemoteDescription(new RTCSessionDescription({sdp:e.sdp,type:"answer"}),function(){console.log("Successfuly generated RemoteDescription for "+t)},n):console.warn("["+c.sessionID+"] Connection with peer '"+t+"' was not previously requested")}else r(e,o)})}var c=this,a=function D(e){return e?(e^16*Math.random()>>e/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,D)},e=e||{},f=e.commonLabels||[],u=e.handshake_servers,l=e.stun_server||"stun.l.google.com:19302";Object.defineProperty(this,"routingLabel",{value:e.routingLabel||"webp2p"}),Object.defineProperty(this,"sessionID",{value:e.sessionID||a()});var d=new MessagePacker(this.sessionID),p=new HandshakeManager(d,u),g=new PeersManager(d,c.routingLabel);this.__defineGetter__("status",function(){return"connected"==g.status?"connected":p.status}),this.__defineGetter__("peers",function(){return g.peers});var v={};this.connectTo=function(e,n,s){if(e==c.sessionID)return s(new Error("Connecting to ourself")),void 0;var r=g.get(e);r?s(null,r):(r=o(e,"offer",function(n){var o=d.offer(e,n,s);v[e]={message:o,peerConnection:r},p.send(o),g.send(o)}),t(r,n))},i(p),i(g),p.on("presence",function(e,n){if(e!=c.sessionID){var s=g.get(e);if(!s){var r=o(e,"offer",function(o){var t=d.offer(e,o);v[e]={message:t,peerConnection:r},n.send(t)});r.addEventListener("signalingstatechange",function(){"stable"==r.signalingState&&n.increaseConnections()}),t(r)}}}),this.close=function(){p.close(),g.close()},window&&window.addEventListener("beforeunload",function(){c.close()})}var EventEmitter=require("events").EventEmitter,RTCPeerConnection=require("wrtc").RTCPeerConnection,HandshakeManager=require("./managers/HandshakeManager"),PeersManager=require("./managers/PeersManager"),MessagePacker=require("./MessagePacker"),applyChannelsShim=require("./PeerConnection_channels.shim");WebP2P.prototype.__proto__=EventEmitter.prototype,WebP2P.prototype.constructor=WebP2P,module.exports=WebP2P;
},{"./MessagePacker":1,"./PeerConnection_channels.shim":2,"./managers/HandshakeManager":10,"./managers/PeersManager":12,"events":13,"wrtc":14}],4:[function(require,module,exports){
function Connector_PubNub(n,o){HandshakeConnector.call(this);var e=this,r=o.channel,t=PUBNUB.init(n);t.subscribe({channel:r,restore:!1,backfill:!1,connect:e._open,message:e._message,disconnect:e._close,error:e._error}),this.close=function(){t.unsubscribe({channel:r}),e._close()},this.send=function(n){t.publish({channel:r,message:n})}}var HandshakeConnector=require("./core/HandshakeConnector"),PUBNUB=require("pubnub");Connector_PubNub.prototype.__proto__=HandshakeConnector.prototype,Connector_PubNub.prototype.constructor=Connector_PubNub,Connector_PubNub.prototype.max_connections=50,Connector_PubNub.prototype.max_chars=1800,module.exports=Connector_PubNub;
},{"./core/HandshakeConnector":7,"pubnub":15}],5:[function(require,module,exports){
function Connector(){EventEmitter.call(this);var e=this;this._open=function(){e.emit("open")},this._message=function(o){e.emit("message",o)},this._close=function(){e.emit("close")},this._error=function(o){e.emit("error",o)}}var EventEmitter=require("events").EventEmitter;Connector.prototype.__proto__=EventEmitter.prototype,Connector.prototype.constructor=Connector,Connector.prototype.close=function(){throw new TypeError("Connector.close should be defined in a child class")},Connector.prototype.send=function(){throw new TypeError("Connector.send should be defined in a child class")},module.exports=Connector;
},{"events":13}],6:[function(require,module,exports){
function Connector_DataChannel(n){Connector.call(this);var e=this;n.addEventListener("open",e._open),n.addEventListener("message",function(n){e._message(JSON.parse(n.data))}),n.addEventListener("close",e._close),n.addEventListener("error",e._error),this.close=function(){n.close()},this.send=function(e){n.send(JSON.stringify(e))}}var Connector=require("./Connector");Connector_DataChannel.prototype.__proto__=Connector.prototype,Connector_DataChannel.prototype.constructor=Connector_DataChannel,module.exports=Connector_DataChannel;
},{"./Connector":5}],7:[function(require,module,exports){
function HandshakeConnector(){Connector.call(this);var n=this;this.shouldConnect=function(){return!0};var o=0;this.increaseConnections=function(){o++,o>=n.max_connections&&n.close()}}var Connector=require("./Connector");HandshakeConnector.prototype.__proto__=Connector.prototype,HandshakeConnector.prototype.constructor=HandshakeConnector,HandshakeConnector.prototype.max_connections=Number.POSITIVE_INFINITY,module.exports=HandshakeConnector;
},{"./Connector":5}],8:[function(require,module,exports){
const ERROR_NETWORK_UNKNOWN={id:0,msg:"Unable to fetch handshake servers configuration"},ERROR_NETWORK_OFFLINE={id:1,msg:"There's no available network"},ERROR_REQUEST_FAILURE={id:2,msg:"Unable to fetch handshake servers configuration"},ERROR_REQUEST_EMPTY={id:3,msg:"Handshake servers configuration is empty"},ERROR_NO_PEERS={id:4,msg:"Not connected to any peer"};exports.ERROR_NETWORK_UNKNOWN=ERROR_NETWORK_UNKNOWN,exports.ERROR_NETWORK_OFFLINE=ERROR_NETWORK_OFFLINE,exports.ERROR_REQUEST_FAILURE=ERROR_REQUEST_FAILURE,exports.ERROR_REQUEST_EMPTY=ERROR_REQUEST_EMPTY,exports.ERROR_NO_PEERS=ERROR_NO_PEERS;
},{}],9:[function(require,module,exports){
var HandshakeConnector=require("./connectors/core/HandshakeConnector"),WebP2P=require("./WebP2P");module.exports=WebP2P,module.exports.HandshakeConnector=HandshakeConnector;
},{"./WebP2P":3,"./connectors/core/HandshakeConnector":7}],10:[function(require,module,exports){
function HandshakeManager(r,n){function e(n){var e=n.type,o=n.config_init,a=n.config_mess,i=s[e];if(!i)throw Error("Invalid handshake server type '"+e+"'");var c=new i(o,a);t._initConnector(c),c.on("open",function(){c.send(r.presence())});var d=c._messageUnpacked;return c._messageUnpacked=function(r){"presence"==r.type?c.shouldConnect()&&t.emit("presence",r.from,c):d.call(c,r)},c}function o(){if(!a.length)throw Error("No handshake servers defined");for(;i<a.length;i++){var r=e(a[i]);return r.on("close",function(){i++,o()}),void 0}i=0}Manager.call(this,r);var t=this,s={};this.registerConnectorConstructor=function(r,n){s[r]=n},this.registerConnectorConstructor("PubNub",Connector_PubNub);var a=[],i=0,c=[];this.addConfigs_byObject=function(r){var n=s[r.type];return n?(n.prototype.max_connections==Number.POSITIVE_INFINITY?(c.push(r),e(r)):(a.push(r),"disconnected"==t.status&&(void 0==i&&(i=0),o())),void 0):(console.error("Invalid handshake server config: ",r),void 0)},this.addConfigs_byArray=function(r){for(var n,e=0;n=r[e];e++)t.addConfigs_byObject(n)},this.addConfigs_byUri=function(r){function n(r){t.emit("error",r)}var e=new XMLHttpRequest;e.open("GET",r),e.onload=function(){if(200==this.status){var r=JSON.parse(e.response);r.length?this.addConfigs_byArray(r):n(errors.ERROR_REQUEST_EMPTY)}else n(errors.ERROR_REQUEST_FAILURE)},e.onerror=function(){n(navigator.onLine?errors.ERROR_NETWORK_UNKNOWN:errors.ERROR_NETWORK_OFFLINE)},e.send()},this.addConfigs=function(r){"string"==typeof r?this.addConfigs_byUri(r):r instanceof Array?this.addConfigs_byArray(r):this.addConfigs_byObject(r)},n&&this.addConfigs(n)}var Manager=require("./Manager"),errors=require("../errors"),Connector_PubNub=require("../connectors/PubNub");HandshakeManager.prototype.__proto__=Manager.prototype,HandshakeManager.prototype.constructor=HandshakeManager,module.exports=HandshakeManager;
},{"../connectors/PubNub":4,"../errors":8,"./Manager":11}],11:[function(require,module,exports){
function Manager(e){EventEmitter.call(this);var n=this;this._connectors=[],this.__defineGetter__("status",function(){return this._connectors.length?"connected":"disconnected"}),this._initConnector=function(t){t.on("open",function(){n._connectors.push(t),1==n._connectors.length&&n.emit("connected")}),t.on("close",function(){n._connectors.splice(n._connectors.indexOf(t),1),0==n._connectors.length&&n.emit("disconnected")}),t.on("error",function(e){t.close(),n.emit("error",e)}),t._messageUnpacked=function(e){switch(e.type){case"offer":case"answer":n.emit(e.type,e,t);break;default:console.error("Unknown message type '"+type+"'"),console.error(e)}},t.on("message",function(n){n=e.unpack(n),n&&(n.stored?t.send(n):t._messageUnpacked(n))})},this.send=function(e,n){for(var t,o=0;t=this._connectors[o];o++)t!==n&&t.send(e)},this.close=function(){for(var e,n=0;e=this._connectors[n];n++)e.close()}}var EventEmitter=require("events").EventEmitter;Manager.prototype.__proto__=EventEmitter.prototype,Manager.prototype.constructor=Manager,module.exports=Manager;
},{"events":13}],12:[function(require,module,exports){
function PeersManager(e,n){function r(e){var n=new Connector_DataChannel(e);return a._initConnector(n),n}Manager.call(this,e);var a=this,t={};this.__defineGetter__("peers",function(){return t}),this.add=function(e,a){a.addEventListener("signalingstatechange",function(){"closed"==a.signalingState&&delete t[e]});for(var o,i=a.getDataChannels(),s=0;o=i[s];s++)if(o.label==n){var c=r(o);c.sessionID=e;break}t[e]=a},this.get=function(e){return t[e]}}var Manager=require("./Manager"),Connector_DataChannel=require("../connectors/core/DataChannel");PeersManager.prototype.__proto__=Manager.prototype,PeersManager.prototype.constructor=PeersManager,module.exports=PeersManager;
},{"../connectors/core/DataChannel":6,"./Manager":11}],13:[function(require,module,exports){
function EventEmitter(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function isFunction(e){return"function"==typeof e}function isNumber(e){return"number"==typeof e}function isObject(e){return"object"==typeof e&&null!==e}function isUndefined(e){return void 0===e}module.exports=EventEmitter,EventEmitter.EventEmitter=EventEmitter,EventEmitter.prototype._events=void 0,EventEmitter.prototype._maxListeners=void 0,EventEmitter.defaultMaxListeners=10,EventEmitter.prototype.setMaxListeners=function(e){if(!isNumber(e)||0>e||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},EventEmitter.prototype.emit=function(e){var t,n,s,i,r,o;if(this._events||(this._events={}),"error"===e&&(!this._events.error||isObject(this._events.error)&&!this._events.error.length))throw t=arguments[1],t instanceof Error?t:TypeError('Uncaught, unspecified "error" event.');if(n=this._events[e],isUndefined(n))return!1;if(isFunction(n))switch(arguments.length){case 1:n.call(this);break;case 2:n.call(this,arguments[1]);break;case 3:n.call(this,arguments[1],arguments[2]);break;default:for(s=arguments.length,i=new Array(s-1),r=1;s>r;r++)i[r-1]=arguments[r];n.apply(this,i)}else if(isObject(n)){for(s=arguments.length,i=new Array(s-1),r=1;s>r;r++)i[r-1]=arguments[r];for(o=n.slice(),s=o.length,r=0;s>r;r++)o[r].apply(this,i)}return!0},EventEmitter.prototype.addListener=function(e,t){var n;if(!isFunction(t))throw TypeError("listener must be a function");if(this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,isFunction(t.listener)?t.listener:t),this._events[e]?isObject(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,isObject(this._events[e])&&!this._events[e].warned){var n;n=isUndefined(this._maxListeners)?EventEmitter.defaultMaxListeners:this._maxListeners,n&&n>0&&this._events[e].length>n&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),console.trace())}return this},EventEmitter.prototype.on=EventEmitter.prototype.addListener,EventEmitter.prototype.once=function(e,t){function n(){this.removeListener(e,n),s||(s=!0,t.apply(this,arguments))}if(!isFunction(t))throw TypeError("listener must be a function");var s=!1;return n.listener=t,this.on(e,n),this},EventEmitter.prototype.removeListener=function(e,t){var n,s,i,r;if(!isFunction(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(n=this._events[e],i=n.length,s=-1,n===t||isFunction(n.listener)&&n.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(isObject(n)){for(r=i;r-->0;)if(n[r]===t||n[r].listener&&n[r].listener===t){s=r;break}if(0>s)return this;1===n.length?(n.length=0,delete this._events[e]):n.splice(s,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},EventEmitter.prototype.removeAllListeners=function(e){var t,n;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(n=this._events[e],isFunction(n))this.removeListener(e,n);else for(;n.length;)this.removeListener(e,n[n.length-1]);return delete this._events[e],this},EventEmitter.prototype.listeners=function(e){var t;return t=this._events&&this._events[e]?isFunction(this._events[e])?[this._events[e]]:this._events[e].slice():[]},EventEmitter.listenerCount=function(e,t){var n;return n=e._events&&e._events[t]?isFunction(e._events[t])?1:e._events[t].length:0};
},{}],14:[function(require,module,exports){
var RTCIceCandidate=window.mozRTCIceCandidate||window.webkitRTCIceCandidate||window.RTCIceCandidate,RTCPeerConnection=window.mozRTCPeerConnection||window.webkitRTCPeerConnection||window.RTCPeerConnection,RTCSessionDescription=window.mozRTCSessionDescription||window.webkitRTCSessionDescription||window.RTCSessionDescription;exports.RTCIceCandidate=RTCIceCandidate,exports.RTCPeerConnection=RTCPeerConnection,exports.RTCSessionDescription=RTCSessionDescription;
},{}],15:[function(require,module,exports){
!function(){function x(){return function(){}}function ga(){return"x"+ ++aa+ +new Date}function J(){return+new Date}function ka(n,e){var o=n.join(ca),r=[];return e?(Q(e,function(n,e){"undefined"!=typeof e&&e!=t&&0<encodeURIComponent(e).length&&r.push(n+"="+encodeURIComponent(e))}),o+="?"+r.join(da)):o}function la(n,e){function t(){r+e>J()?(clearTimeout(o),o=setTimeout(t,e)):(r=J(),n())}var o,r=0;return t}function na(n,e){var t=[];return Q(n||[],function(n){e(n)&&t.push(n)}),t}function oa(n,e){return n.replace(fa,function(n,t){return e[t]||n})}function ja(n){var e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var e=0|16*Math.random();return("x"==n?e:8|3&e).toString(16)});return n&&n(e),e}function Q(n,e){if(n&&e)if("undefined"!=typeof n[0])for(var t=0,o=n.length;o>t;)e.call(n[t],n[t],t++);else for(t in n)n.hasOwnProperty&&n.hasOwnProperty(t)&&e.call(n[t],t,n[t])}function pa(n,e){var t=[];return Q(n||[],function(n,o){t.push(e(n,o))}),t}function qa(n){var e=[];return Q(n,function(n,t){t.j&&e.push(n)}),e.sort()}function ra(){setTimeout(function(){C||(C=1,Q(ba,function(n){n()}))},I)}var j=!0,t=null,u=!1;window.JSON&&window.JSON.stringify||function(){function a(){try{return this.valueOf()}catch(n){return t}}function c(n){return d.lastIndex=0,d.test(n)?'"'+n.replace(d,function(n){var e=H[n];return"string"==typeof e?e:"\\u"+("0000"+n.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+n+'"'}function b(n,t){var o,r,i,u,f,l=e,d=t[n];switch(d&&"object"==typeof d&&(d=a.call(d)),"function"==typeof m&&(d=m.call(t,n,d)),typeof d){case"string":return c(d);case"number":return isFinite(d)?String(d):"null";case"boolean":case"null":return String(d);case"object":if(!d)return"null";if(e+=s,f=[],"[object Array]"===Object.prototype.toString.apply(d)){for(u=d.length,o=0;u>o;o+=1)f[o]=b(o,d)||"null";return i=0===f.length?"[]":e?"[\n"+e+f.join(",\n"+e)+"\n"+l+"]":"["+f.join(",")+"]",e=l,i}if(m&&"object"==typeof m)for(u=m.length,o=0;u>o;o+=1)r=m[o],"string"==typeof r&&(i=b(r,d))&&f.push(c(r)+(e?": ":":")+i);else for(r in d)Object.hasOwnProperty.call(d,r)&&(i=b(r,d))&&f.push(c(r)+(e?": ":":")+i);return i=0===f.length?"{}":e?"{\n"+e+f.join(",\n"+e)+"\n"+l+"}":"{"+f.join(",")+"}",e=l,i}}window.JSON||(window.JSON={});var d=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,e,s,H={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},m;"function"!=typeof JSON.stringify&&(JSON.stringify=function(n,t,o){var r;if(s=e="","number"==typeof o)for(r=0;o>r;r+=1)s+=" ";else"string"==typeof o&&(s=o);if((m=t)&&"function"!=typeof t&&("object"!=typeof t||"number"!=typeof t.length))throw Error("JSON.stringify");return b("",{"":n})}),"function"!=typeof JSON.parse&&(JSON.parse=function(a){return eval("("+a+")")})}();var aa=1,C=u,ba=[],G="-pnpres",I=1e3,ca="/",da="&",fa=/{([\w\-]+)}/g,P,ha=Math.floor(20*Math.random());if(P=function(n,e){return 0<n.indexOf("pubsub.")&&n.replace("pubsub","ps"+(e?ja().split("-")[0]:20>++ha?ha:ha=1))||n},!window.PUBNUB){var sa=function(n,e){return CryptoJS.HmacSHA256(n,e).toString(CryptoJS.enc.Base64)},ta=function(n){return document.getElementById(n)},ua=function(n){console.error(n)},va=function(n,e){var t=[];return Q(n.split(/\s+/),function(n){Q((e||document).getElementsByTagName(n),function(n){t.push(n)})}),t},U=function(n,e,t){Q(n.split(","),function(n){function o(n){n||(n=window.event),t(n)||(n.cancelBubble=j,n.preventDefault&&n.preventDefault(),n.stopPropagation&&n.stopPropagation())}e.addEventListener?e.addEventListener(n,o,u):e.attachEvent?e.attachEvent("on"+n,o):e["on"+n]=o})},xa=function(){return va("head")[0]},V=function(n,e,t){return t?(n.setAttribute(e,t),void 0):n&&n.getAttribute&&n.getAttribute(e)},ya=function(n,e){for(var t in e)if(e.hasOwnProperty(t))try{n.style[t]=e[t]+(0<"|width|height|top|left|".indexOf(t)&&"number"==typeof e[t]?"px":"")}catch(o){}},Ba=function(n){return document.createElement(n)},Da=function(){return Ca||W()?0:ga()},Fa=function(n){function e(n,e){v||(v=1,g.onerror=t,clearTimeout(w),n||!e||C(e),setTimeout(function(){n&&k();var e=ta(y),t=e&&e.parentNode;t&&t.removeChild(e)},I))}if(Ca||W()){n:{var o,r,i=function(){if(!u){u=1,clearTimeout(s);try{r=JSON.parse(o.responseText)}catch(n){return b(1)}a=1,d(r)}},a=0,u=0,c=n.timeout||1e4,s=setTimeout(function(){b(1)},c),f=n.b||x(),l=n.data||{},d=n.c||x(),p="undefined"==typeof n.g,b=function(n,e){a||(a=1,clearTimeout(s),o&&(o.onerror=o.onload=t,o.abort&&o.abort(),o=t),n&&f(e))};try{o=W()||window.XDomainRequest&&new XDomainRequest||new XMLHttpRequest,o.onerror=o.onabort=function(){b(1,o.responseText||{error:"Network Connection Error"})},o.onload=o.onloadend=i,o.onreadystatechange=function(){if(o&&4==o.readyState)switch(o.status){case 401:case 402:case 403:try{r=JSON.parse(o.responseText),b(1,r)}catch(n){return b(1,o.responseText)}}},p&&(o.timeout=c),l.pnsdk=Ea;var h=ka(n.url,l);o.open("GET",h,p),o.send()}catch(m){b(0),Ca=0,n=Fa(n);break n}n=b}return n}var g=Ba("script"),i=n.a,y=ga(),v=0,w=setTimeout(function(){e(1)},n.timeout||1e4),k=n.b||x(),c=n.data||{},C=n.c||x();return window[i]=function(n){e(0,n)},n.g||(g[Ga]=Ga),g.onerror=function(){e(1)},c.pnsdk=Ea,g.src=ka(n.url,c),V(g,"id",y),xa().appendChild(g),e},Ha=function(){return"onLine"in navigator?navigator.onLine:1},W=function(){if(!Ia||!Ia.get)return 0;var n={id:W.id++,send:x(),abort:function(){n.id={}},open:function(e,t){W[n.id]=n,Ia.get(n.id,t)}};return n},Ga="async",Ea="PubNub-JS-Web/3.5.48",Ca=-1==navigator.userAgent.indexOf("MSIE 6");window.console||(window.console=window.console||{}),console.log||(console.log=console.error=(window.opera||{}).postError||x());var Ja,Ka=window.localStorage;Ja={get:function(n){try{return Ka?Ka.getItem(n):-1==document.cookie.indexOf(n)?t:((document.cookie||"").match(RegExp(n+"=([^;]+)"))||[])[1]||t}catch(e){}},set:function(n,e){try{if(Ka)return Ka.setItem(n,e)&&0;document.cookie=n+"="+e+"; expires=Thu, 1 Aug 2030 20:00:00 UTC; path=/"}catch(t){}}};var Y={list:{},unbind:function(n){Y.list[n]=[]},bind:function(n,e){(Y.list[n]=Y.list[n]||[]).push(e)},fire:function(n,e){Q(Y.list[n]||[],function(n){n(e)})}},Z=ta("pubnub")||0,La=function(n){function e(){}function o(n,e){function t(e){e&&(E=J()-(e/1e4+(J()-o)/2),n&&n(E))}var o=J();e&&t(e)||X.time(t)}function r(n,e){L&&L(n,e),L=t}function i(){X.time(function(n){o(x(),n),n||r(1,{error:"Heartbeat failed to connect to Pubnub Servers.Please check your network settings."}),setTimeout(i,b)})}function a(){q()||r(1,{error:"Offline. Please check your network settings. "}),setTimeout(a,I)}function c(n){var e=0;return Q(qa(K),function(t){(t=K[t])&&(e++,(n||x())(t))}),e}function s(n){if(D){if(!N.length)return}else{if(n&&(N.h=0),N.h||!N.length)return;N.h=1}W(N.shift())}n.jsonp&&(Ca=0);var f=n.subscribe_key||"";n.uuid||Ja.get(f+"uuid"),n.xdr=Fa,n.db=Ja,n.error=ua,n._is_online=Ha,n.jsonp_cb=Da,n.PNSDK=Ea,n.hmac_SHA256=sa;var l,d=+n.windowing||10,p=(+n.timeout||310)*I,b=(+n.keepalive||60)*I,h=n.noleave||0,m=n.publish_key||"demo",g=n.subscribe_key||"demo",y=n.auth_key||"",v=n.secret_key||"",w=n.PNSDK||"",k=n.hmac_SHA256,S=n.ssl?"s":"",O="http"+S+"://"+(n.origin||"pubsub.pubnub.com"),_=P(O),M=P(O),N=[],E=0,T=0,R=0,L=0,A=0,B=0,K={},D=n.no_wait_for_pending,W=n.xdr,H=n.error||x(),q=n._is_online||function(){return 1},$=n.jsonp_cb||function(){return 0},Z=n.db||{get:x(),set:x()},F=n.uuid||Z&&Z.get(g+"uuid")||"",X={LEAVE:function(n,e,t,o){var r={uuid:F,auth:y},i=P(O),t=t||x(),a=o||x(),o=$();return 0<n.indexOf(G)?j:h||!S||"0"==o?u:("0"!=o&&(r.callback=o),W({g:e||S,timeout:2e3,a:o,data:r,c:function(n){"object"==typeof n&&n.error?a(n):t(n)},b:a,url:[i,"v2","presence","sub_key",g,"channel",encodeURIComponent(n),"leave"]}),j)},history:function(n,e){var e=n.callback||e,t=n.count||n.limit||100,o=n.reverse||"false",r=n.error||x(),i=n.auth_key||y,a=n.channel,u=n.start,c=n.end,s={},f=$();return a?e?g?(s.stringtoken="true",s.count=t,s.reverse=o,s.auth=i,f&&(s.callback=f),u&&(s.start=u),c&&(s.end=c),W({a:f,data:s,c:function(n){"object"==typeof n&&n.error?r(n):e(n)},b:r,url:[_,"v2","history","sub-key",g,"channel",encodeURIComponent(a)]}),void 0):H("Missing Subscribe Key"):H("Missing Callback"):H("Missing Channel")},replay:function(n){var e=e||n.callback||x(),t=n.auth_key||y,o=n.source,r=n.destination,i=n.stop,a=n.start,u=n.end,c=n.reverse,n=n.limit,s=$(),f={};return o?r?m?g?("0"!=s&&(f.callback=s),i&&(f.stop="all"),c&&(f.reverse="true"),a&&(f.start=a),u&&(f.end=u),n&&(f.count=n),f.auth=t,W({a:s,c:function(n){"object"==typeof n&&n.error?err(n):e(n)},b:function(){e([0,"Disconnected"])},url:[_,"v1","replay",m,g,o,r],data:f}),void 0):H("Missing Subscribe Key"):H("Missing Publish Key"):H("Missing Destination Channel"):H("Missing Source Channel")},auth:function(n){y=n,e()},time:function(n){var e=$();W({a:e,data:{uuid:F,auth:y},timeout:5*I,url:[_,"time",e],c:function(e){n(e[0])},b:function(){n(0)}})},publish:function(n,e){var e=e||n.callback||x(),t=n.message,o=n.channel,r=n.auth_key||y,i=n.error||x(),a=$(),u="push";return n.prepend&&(u="unshift"),t?o?m?g?(t=JSON.stringify(t),N[u]({a:a,timeout:5*I,url:[_,"publish",m,g,0,encodeURIComponent(o),a,encodeURIComponent(t)],data:{uuid:F,auth:r},b:function(n){i(n),s(1)},c:function(n){"object"==typeof n&&n.error?i(n):e(n),s(1)}}),s(),void 0):H("Missing Subscribe Key"):H("Missing Publish Key"):H("Missing Channel"):H("Missing Message")},unsubscribe:function(n,t){var o=n.channel,t=t||n.callback||x(),r=n.error||x();B=0,A=1,o=pa((o.join?o.join(","):""+o).split(","),function(n){return K[n]?n+","+n+G:void 0}).join(","),Q(o.split(","),function(n){var e=j;n&&(C&&(e=X.LEAVE(n,0,t,r)),e||t({action:"leave"}),K[n]=0)}),e()},subscribe:function(n,o){function i(n){n?setTimeout(e,I):(_=P(O,1),M=P(O,1),setTimeout(function(){X.time(i)},I)),c(function(e){return n&&e.d?(e.d=0,e.m(e.name)):(!n&&!e.d&&(e.d=1,e.l(e.name)),void 0)})}function a(){var n=$(),o=qa(K).join(",");o&&(r(),L=W({timeout:j,a:n,b:function(n){h(n),L=t,X.time(i)},data:{uuid:F,auth:s},url:[M,"subscribe",g,encodeURIComponent(o),n,B],c:function(n){if(L=t,!n||"object"==typeof n&&"error"in n&&n.error)return h(n),setTimeout(e,I);m(n[1]),B=!B&&A&&Z.get(g)||n[1],c(function(n){n.f||(n.f=1,n.k(n.name))}),k&&(B=1e4,k=0),Z.set(g,n[1]);var o,r=(2<n.length?n[2]:pa(K,function(e){return pa(Array(n[0].length).join(",").split(","),function(){return e})}).join(",")).split(",");o=function(){var n=r.shift()||R;return[(K[n]||{}).a||T,n.split(G)[0]]};var i=J()-E-+n[1]/1e4;Q(n[0],function(e){var t=o();t[0](e,n,t[1],i)}),setTimeout(a,U)}}))}var u=n.channel,o=(o=o||n.callback)||n.message,s=n.auth_key||y,f=n.connect||x(),l=n.reconnect||x(),b=n.disconnect||x(),h=n.error||x(),m=n.idle||x(),v=n.presence||0,w=n.noheresync||0,k=n.backfill||0,S=n.timetoken||0,j=n.timeout||p,U=n.windowing||d;return A=n.restore,B=S,u?o?g?(Q((u.join?u.join(","):""+u).split(","),function(n){var e=K[n]||{};K[R=n]={name:n,f:e.f,d:e.d,j:1,a:T=o,k:f,l:b,m:l},v&&(X.subscribe({channel:n+G,callback:v}),!e.j&&!w&&X.here_now({channel:n,callback:function(e){Q("uuids"in e?e.uuids:[],function(t){v({action:"join",uuid:t,timestamp:J(),occupancy:e.occupancy||1},e,n)})}}))}),e=function(){r(),setTimeout(a,U)},C?(e(),void 0):ba.push(e)):H("Missing Subscribe Key"):H("Missing Callback"):H("Missing Channel")},here_now:function(n,e){var e=n.callback||e,t=n.error||x(),o=n.auth_key||y,r=n.channel,i=$(),o={uuid:F,auth:o};return r?e?g?("0"!=i&&(o.callback=i),W({a:i,data:o,c:function(n){"object"==typeof n&&n.error?t(n):e(n)},b:t,url:[_,"v2","presence","sub_key",g,"channel",encodeURIComponent(r)]}),void 0):H("Missing Subscribe Key"):H("Missing Callback"):H("Missing Channel")},grant:function(n,e){var e=n.callback||e,t=n.error||x(),o=n.channel,r=$(),i=n.ttl||-1,a=n.read?"1":"0",u=n.write?"1":"0",c=n.auth_key;if(!o)return H("Missing Channel");if(!e)return H("Missing Callback");if(!g)return H("Missing Subscribe Key");if(!m)return H("Missing Publish Key");if(!v)return H("Missing Secret Key");"0"!=r&&(s.callback=r);var s=Math.floor((new Date).getTime()/1e3),f=k(g+"\n"+m+"\ngrant\n"+(c&&0<encodeURIComponent(c).length?"auth="+encodeURIComponent(c)+"&":"")+"channel="+encodeURIComponent(o)+"&pnsdk="+encodeURIComponent(w)+"&r="+a+"&timestamp="+encodeURIComponent(s)+(i>-1?"&ttl="+i:"")+"&w="+u,v),f=f.replace(/\+/g,"-"),f=f.replace(/\//g,"_"),s={w:u,r:a,signature:f,channel:encodeURIComponent(o),timestamp:s};i>-1&&(s.ttl=i),c&&(s.auth=encodeURIComponent(c)),W({a:r,data:s,c:function(n){e(n)},b:t,url:[_,"v1","auth","grant","sub-key",g]})},audit:function(n,e){var e=n.callback||e,t=n.error||x(),o=n.channel,r=n.auth_key,i=$();if(!e)return H("Missing Callback");if(!g)return H("Missing Subscribe Key");if(!m)return H("Missing Publish Key");if(!v)return H("Missing Secret Key");"0"!=i&&(a.callback=i);var a=Math.floor((new Date).getTime()/1e3),u=g+"\n"+m+"\naudit\n";r&&(u+="auth="+encodeURIComponent(r)+"&"),o&&(u+="channel="+encodeURIComponent(o)+"&");var u=u+("pnsdk="+encodeURIComponent(w)+"&timestamp="+a),u=k(u,v),u=u.replace(/\+/g,"-"),u=u.replace(/\//g,"_"),a={signature:u,timestamp:a};o&&(a.channel=encodeURIComponent(o)),r&&(a.auth=encodeURIComponent(r)),W({a:i,data:a,c:function(n){e(n)},b:t,url:[_,"v1","auth","audit","sub-key",g]})},revoke:function(n,e){n.read=u,n.write=u,X.grant(n,e)},set_uuid:function(n){F=n,e()},get_uuid:function(){return F},xdr:W,ready:ra,db:Z,uuid:ja,map:pa,each:Q,"each-channel":c,grep:na,offline:function(){r(1)},supplant:oa,now:J,unique:ga,updater:la};return F||(F=X.uuid()),Z.set(g+"uuid",F),setTimeout(a,I),setTimeout(i,b),o(),l=X,l.css=ya,l.$=ta,l.create=Ba,l.bind=U,l.head=xa,l.search=va,l.attr=V,l.events=Y,l.init=La,U("beforeunload",window,function(){return l["each-channel"](function(n){l.LEAVE(n.name,0)}),j}),n.notest?l:(U("offline",window,l.offline),U("offline",document,l.offline),l)};"complete"===document.readyState?setTimeout(ra,0):U("load",window,function(){setTimeout(ra,0)});var $=Z||{};PUBNUB=La({notest:1,publish_key:V($,"pub-key"),subscribe_key:V($,"sub-key"),ssl:!document.location.href.indexOf("https")||"on"==V($,"ssl"),origin:V($,"origin"),uuid:V($,"uuid")}),window.jQuery&&(window.jQuery.PUBNUB=PUBNUB),"undefined"!=typeof module&&(module.exports=PUBNUB)&&ra();var Ia=ta("pubnubs")||0;Z&&(ya(Z,{position:"absolute",top:-I}),("opera"in window||V(Z,"flash"))&&(Z.innerHTML="<object id=pubnubs data=https://pubnub.a.ssl.fastly.net/pubnub.swf><param name=movie value=https://pubnub.a.ssl.fastly.net/pubnub.swf><param name=allowscriptaccess value=always></object>"),PUBNUB.rdx=function(n,e){return e?(W[n].responseText=unescape(e),W[n].onload(),void 0):W[n].onerror()},W.id=I)}var Ma=PUBNUB.ws=function(n,e){if(!(this instanceof Ma))return new Ma(n,e);var t=this,n=t.url=n||"";t.protocol=e||"Sec-WebSocket-Protocol";var o=n.split("/"),o={ssl:"wss:"===o[0],origin:o[2],publish_key:o[3],subscribe_key:o[4],channel:o[5]};return t.CONNECTING=0,t.OPEN=1,t.CLOSING=2,t.CLOSED=3,t.CLOSE_NORMAL=1e3,t.CLOSE_GOING_AWAY=1001,t.CLOSE_PROTOCOL_ERROR=1002,t.CLOSE_UNSUPPORTED=1003,t.CLOSE_TOO_LARGE=1004,t.CLOSE_NO_STATUS=1005,t.CLOSE_ABNORMAL=1006,t.onclose=t.onerror=t.onmessage=t.onopen=t.onsend=x(),t.binaryType="",t.extensions="",t.bufferedAmount=0,t.trasnmitting=u,t.buffer=[],t.readyState=t.CONNECTING,n?(t.e=PUBNUB.init(o),t.e.i=o,t.i=o,t.e.subscribe({restore:u,channel:o.channel,disconnect:t.onerror,reconnect:t.onopen,error:function(){t.onclose({code:t.CLOSE_ABNORMAL,reason:"Missing URL",wasClean:u})},callback:function(n){t.onmessage({data:n})},connect:function(){t.readyState=t.OPEN,t.onopen()}}),void 0):(t.readyState=t.CLOSED,t.onclose({code:t.CLOSE_ABNORMAL,reason:"Missing URL",wasClean:j}),t)};Ma.prototype.send=function(n){var e=this;e.e.publish({channel:e.e.i.channel,message:n,callback:function(n){e.onsend({data:n})}})}}();
},{}]},{},[9])

//# sourceMappingURL=WebP2P.map