;(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
function MessagePacker(e){var r=0;this.pack=function(){},this.unpack=function(e){var r={};switch(e[0]){case PRESENCE:r.type="presence";break;case OFFER:r.type="offer";break;case ANSWER:r.type="answer";break;default:var t=Error("Unknown message type '"+type+"'");throw t.message=e,t}return r.from=e[1],"presence"!=r.type&&(r.dest=e[2],r.id=e[3],r.ttl=e[4],r.sdp=e[5]),r},this.presence=function(){var r=[PRESENCE,e];return r},this.offer=function(t,a){var n=[OFFER,e,t,r++,MAX_TTL_DEFAULT,a];return n},this.answer=function(r,t,a){var n=[ANSWER,e,r,t,MAX_TTL_DEFAULT,a];return n}}const PRESENCE=0,OFFER=1,ANSWER=2;var MAX_TTL_DEFAULT=5;Manager.MAX_ALLOWED_ERROR_TRIES=3,Manager.BASE_TIMEOUT=5e3,module.exports=MessagePacker;
},{}],2:[function(require,module,exports){
function applyChannelsShim(n){function a(n,a){n.createdbyus=a,e.push(n),n.addEventListener("close",function(){e.splice(e.indexOf(n),1)})}if(void 0==n.getDataChannels){var e=[];n.getDataChannels=function(){return e};var t=n.dispatchEvent;n.dispatchEvent=function(n){if("datachannel"==n.type){var e=n.channel;a(e,!1)}t.call(this,n)};var l=n.createDataChannel;n.createDataChannel=function(n,e){var c=l.call(this,n,e);a(c,!0);var i=new Event("datachannel");i.channel=c,t.call(this,i)}}}module.exports=applyChannelsShim;
},{}],3:[function(require,module,exports){
function Connector_PubNub(n,o){HandshakeConnector.call(this);var e=this,t=o.channel,r=PUBNUB.init(n);r.subscribe({channel:t,connect:e._open,message:e._message,disconnect:e._close,error:e._error}),this.close=function(){r.unsubscribe({channel:t})},this.send=function(n){r.publish({channel:t,message:n})}}var HandshakeConnector=require("./core/HandshakeConnector");Connector_PubNub.prototype.__proto__=HandshakeConnector.prototype,Connector_PubNub.prototype.constructor=Connector_PubNub,Connector_PubNub.prototype.max_connections=50,Connector_PubNub.prototype.max_chars=1800,module.exports=Connector_PubNub;
},{"./core/HandshakeConnector":6}],4:[function(require,module,exports){
function Connector(){EventEmitter.call(this);var e=this;this._open=function(){e.emit("open")},this._message=function(o){e.emit("message",o)},this._close=function(){e.emit("close")},this._error=function(o){e.emit("error",o)}}var EventEmitter=require("events").EventEmitter;Connector.prototype.__proto__=EventEmitter.prototype,Connector.prototype.constructor=Connector,Connector.prototype.close=function(){throw new TypeError("Connector.close should be defined in a child class")},Connector.prototype.send=function(){throw new TypeError("Connector.send should be defined in a child class")},module.exports=Connector;
},{"events":12}],5:[function(require,module,exports){
function Connector_DataChannel(n){Connector.call(this);var e=this;n.addEventListener("open",e._open),n.addEventListener("message",function(n){e._message(JSON.parse(n.data))}),n.addEventListener("close",e._close),n.addEventListener("error",e._error),this.close=function(){n.close()},this.send=function(e){n.send(JSON.stringify(e))}}var Connector=require("./Connector");Connector_DataChannel.prototype.__proto__=Connector.prototype,Connector_DataChannel.prototype.constructor=Connector_DataChannel,module.exports=Connector_DataChannel;
},{"./Connector":4}],6:[function(require,module,exports){
function HandshakeConnector(){Connector.call(this);var n=this;this.shouldConnect=function(){return!0};var o=0;this.increaseConnections=function(){o++,o>=n.max_connections&&n.close()}}var Connector=require("./Connector");HandshakeConnector.prototype.__proto__=Connector.prototype,HandshakeConnector.prototype.constructor=HandshakeConnector,HandshakeConnector.prototype.max_connections=Number.POSITIVE_INFINITY,module.exports=HandshakeConnector;
},{"./Connector":4}],7:[function(require,module,exports){
const ERROR_NETWORK_UNKNOWN={id:0,msg:"Unable to fetch handshake servers configuration"},ERROR_NETWORK_OFFLINE={id:1,msg:"There's no available network"},ERROR_REQUEST_FAILURE={id:2,msg:"Unable to fetch handshake servers configuration"},ERROR_REQUEST_EMPTY={id:3,msg:"Handshake servers configuration is empty"},ERROR_NO_PEERS={id:4,msg:"Not connected to any peer"};exports.ERROR_NETWORK_UNKNOWN=ERROR_NETWORK_UNKNOWN,exports.ERROR_NETWORK_OFFLINE=ERROR_NETWORK_OFFLINE,exports.ERROR_REQUEST_FAILURE=ERROR_REQUEST_FAILURE,exports.ERROR_REQUEST_EMPTY=ERROR_REQUEST_EMPTY,exports.ERROR_NO_PEERS=ERROR_NO_PEERS;
},{}],8:[function(require,module,exports){
function WebP2P(e){function n(e){a.emit("error",e)}function t(e,n,t){var o=new RTCPeerConnection({iceServers:[{url:"stun:"+l}]},{optional:[{DtlsSrtpKeyAgreement:!0}]});return applyChannelsShim(o),a.emit("peerconnection",o),o.createDataChannel(a.routingLabel),o.addEventListener("icecandidate",function(e){if(!e.candidate){var o=this.localDescription.type,r=this.localDescription.sdp;o==n?t(r):console.error(o+" SDP type is not equal to "+n+" callback type")}}),o.addEventListener("open",function(){p.add(e,o)}),o}function o(e){for(var t,o=0;t=f[o];o++)e.createDataChannel(t);var r={mandatory:{OfferToReceiveAudio:!1,OfferToReceiveVideo:!1}};e.createOffer(function(t){e.setLocalDescription(t,function(){console.log("LocalDescription correctly set for "+from)},n)},n,r)}function r(e){e.setRemoteDescription(new RTCSessionDescription({sdp:message.sdp,type:"offer"}),function(){e.createAnswer(function(t){e.setLocalDescription(t,function(){console.log("Generated Answer LocalDescription for "+from)},n)},n)},n)}function s(e,n){if(--e.ttl<=0)return console.warning("TTL achieved: "+e),void 0;e.ttl=min(e.ttl,MAX_TTL_DEFAULT);var t=e.dest;e=messagepacker.pack(e);for(var o,r=0;o=p._connectors[r];r++)if(o.sessionID===t)return o.send(e),void 0;p.send(e,n),d.send(e,n)}function i(e){e.on("connected",function(){d.status!=p.status&&a.emit("connected")}),e.on("disconnected",function(){d.status==p.status&&a.emit("disconnected")}),e.on("error",function(e){a.emit("error",e)}),e.on("offer",function(e,n){var o=e.from,i=e.dest;if(console.log("Received connection request from "+o),i==sessionID){var a=t(o,"answer",function(e){var t=messagepacker.answer(o,t.id,e);n.send(t)});r(a)}else s(e,n)}),e.on("answer",function(e,t){var o=e.from,r=e.dest;if(r==sessionID){console.log("Received connection response from "+o);var i=p.get(o);i?(i.setRemoteDescription(new RTCSessionDescription({sdp:sdp,type:"answer"}),function(){console.log("Successfuly generated RemoteDescription for "+o)},n),t.increaseConnections()):n("Connection with peer '"+o+"' was not previously requested")}else s(e,t)})}var a=this,c=function v(e){return e?(e^16*Math.random()>>e/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,v)},e=e||{},f=e.commonLabels||[],u=e.handshake_servers,l=e.stun_server||"stun.l.google.com:19302";Object.defineProperty(this,"routingLabel",{value:e.routingLabel||"webp2p"}),Object.defineProperty(this,"sessionID",{value:e.sessionID||c()}),new MessagePacker(this.sessionID);var d=new HandshakeManager(u,messagepacker),p=new PeersManager(a.routingLabel);this.__defineGetter__("status",function(){return"connected"==p.status?"connected":d.status}),this.connectTo=function(e,n,r){var s=p.get(e);s?r(null,s):(s=t(e,"offer",function(n){var t=messagepacker.offer(e,n,r);d.send(t),p.send(t)}),o(s,n))},i(d),i(p),d.on("presence",function(e,n){var r=p.get(e);if(!r){var s=t(e,"offer",function(t){var o=messagepacker.offer(e,t);n.send(o)});o(s,labels)}}),this.close=function(){d.close(),p.close()},window&&window.addEventListener("beforeunload",function(){a.close()})}var EventEmitter=require("events").EventEmitter,HandshakeManager=require("./managers/HandshakeManager"),PeersManager=require("./managers/PeersManager"),MessagePacker=require("./MessagePacker"),applyChannelsShim=require("./PeerConnection_channels.shim");WebP2P.prototype.__proto__=EventEmitter.prototype,WebP2P.prototype.constructor=WebP2P,exports.WebP2P=WebP2P;
},{"./MessagePacker":1,"./PeerConnection_channels.shim":2,"./managers/HandshakeManager":9,"./managers/PeersManager":11,"events":12}],9:[function(require,module,exports){
function HandshakeManager(n,e){function r(n){var r=n.type,o=n.config_init,s=n.config_mess,a=handshakeConnectorsConstructors[r];if(!a)throw Error("Invalid handshake server type '"+r+"'");var i=new a(o,s);return t._initConnector(i),i.on("open",function(){i.send(e.presence())}),i._messageUnpacked=function(n){"presence"==n.type?i.shouldConnect()&&t.emit("presence",n.from,i):Manager._messageUnpacked.call(this,n)},i}function o(){if(!a.length)throw Error("No handshake servers defined");for(;i<a.length;i++){var n=r(a[i]);if(n)return n.on("close",function(){i++,o()}),void 0}i=0,"disconnected"==t.status&&t.emit("disconnected")}Manager.call(this);var t=this,s={};this.registerConnectorConstructor=function(n,e){s[n]=e},this.registerConnectorConstructor("PubNub",Connector_PubNub);var a=[],i=0,c=[];this.addConfigs_byObject=function(n){var e=handshakeConnectorsConstructors[type];if(!e)return console.error("Invalid handshake server config: "+n),void 0;if(e.prototype.max_connections==Number.POSITIVE_INFINITY){c.push(n);var s=r(n);s.on("close",function(){"disconnected"==t.status&&t.emit("disconnected")})}else a.push(n),"disconnected"==t.status&&(void 0==i&&(i=0),o())},this.addConfigs_byArray=function(n){for(var e,r=0;e=n[r];r++)t.addConfigs_byObject(e)},this.addConfigs_byUri=function(n){function e(n){t.emit("error",n)}var r=new XMLHttpRequest;r.open("GET",n),r.onload=function(){if(200==this.status){var n=JSON.parse(r.response);n.length?this.addConfigs_byArray(n):e(errors.ERROR_REQUEST_EMPTY)}else e(errors.ERROR_REQUEST_FAILURE)},r.onerror=function(){e(navigator.onLine?errors.ERROR_NETWORK_UNKNOWN:errors.ERROR_NETWORK_OFFLINE)},r.send()},this.addConfigs=function(n){"string"==typeof n?this.addConfigs_byUri(n):n instanceof Array?this.addConfigs_byArray(n):this.addConfigs_byObject(n)},n&&this.addConfigs(n)}var Manager=require("./Manager"),errors=require("../errors"),Connector_PubNub=require("../connectors/PubNub");HandshakeManager.prototype.__proto__=Manager.prototype,HandshakeManager.prototype.constructor=HandshakeManager,module.exports=HandshakeManager;
},{"../connectors/PubNub":3,"../errors":7,"./Manager":10}],10:[function(require,module,exports){
function Manager(){EventEmitter.call(this);var e=this;this._connectors=[],this.__defineGetter__("status",function(){return this._connectors.length?"connected":"disconnected"}),this._initConnector=function(n){n.on("open",function(){"disconnected"==e.status&&e.emit("connected"),e._connectors.push(n)}),n.on("close",function(){e._connectors.splice(e._connectors.indexOf(n),1)}),n.on("error",function(t){n.close(),e.emit("error",t)}),n._messageUnpacked=function(t){switch(t.type){case"offer":case"answer":e.emit(t.type,t,n);break;default:console.error("Unknown message type '"+type+"'"),console.error(t)}},n.on("message",function(e){n._messageUnpacked(messagepacker.unpack(e))})},this.send=function(e,n){for(var t,o=0;t=this._connectors[o];o++)t!==n&&t.send(e)},this.close=function(){for(var e,n=0;e=this._connectors[n];n++)e.close()}}var EventEmitter=require("events").EventEmitter;Manager.prototype.__proto__=EventEmitter.prototype,Manager.prototype.constructor=Manager,module.exports=Manager;
},{"events":12}],11:[function(require,module,exports){
function PeersManager(e){function n(e){var n=new Connector_DataChannel(e);return this._initConnector(n),n}Manager.call(this);var a=this,r={};this.add=function(t,o){o.addEventListener("signalingstatechange",function(){"closed"==o.signalingState&&delete r[t]});for(var s,i=o.getDataChannels(),c=0;s=i[c];c++)s.label==e&&a._connectors.push(n(s));r[t]=o},this.get=function(e){return r[e]}}var Manager=require("./Manager"),Connector_DataChannel=require("../connectors/core/DataChannel");PeersManager.prototype.__proto__=Manager.prototype,PeersManager.prototype.constructor=PeersManager,module.exports=PeersManager;
},{"../connectors/core/DataChannel":5,"./Manager":10}],12:[function(require,module,exports){
function EventEmitter(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function isFunction(e){return"function"==typeof e}function isNumber(e){return"number"==typeof e}function isObject(e){return"object"==typeof e&&null!==e}function isUndefined(e){return void 0===e}module.exports=EventEmitter,EventEmitter.EventEmitter=EventEmitter,EventEmitter.prototype._events=void 0,EventEmitter.prototype._maxListeners=void 0,EventEmitter.defaultMaxListeners=10,EventEmitter.prototype.setMaxListeners=function(e){if(!isNumber(e)||0>e||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},EventEmitter.prototype.emit=function(e){var t,n,s,i,r,o;if(this._events||(this._events={}),"error"===e&&(!this._events.error||isObject(this._events.error)&&!this._events.error.length))throw t=arguments[1],t instanceof Error?t:TypeError('Uncaught, unspecified "error" event.');if(n=this._events[e],isUndefined(n))return!1;if(isFunction(n))switch(arguments.length){case 1:n.call(this);break;case 2:n.call(this,arguments[1]);break;case 3:n.call(this,arguments[1],arguments[2]);break;default:for(s=arguments.length,i=new Array(s-1),r=1;s>r;r++)i[r-1]=arguments[r];n.apply(this,i)}else if(isObject(n)){for(s=arguments.length,i=new Array(s-1),r=1;s>r;r++)i[r-1]=arguments[r];for(o=n.slice(),s=o.length,r=0;s>r;r++)o[r].apply(this,i)}return!0},EventEmitter.prototype.addListener=function(e,t){var n;if(!isFunction(t))throw TypeError("listener must be a function");if(this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,isFunction(t.listener)?t.listener:t),this._events[e]?isObject(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,isObject(this._events[e])&&!this._events[e].warned){var n;n=isUndefined(this._maxListeners)?EventEmitter.defaultMaxListeners:this._maxListeners,n&&n>0&&this._events[e].length>n&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),console.trace())}return this},EventEmitter.prototype.on=EventEmitter.prototype.addListener,EventEmitter.prototype.once=function(e,t){function n(){this.removeListener(e,n),s||(s=!0,t.apply(this,arguments))}if(!isFunction(t))throw TypeError("listener must be a function");var s=!1;return n.listener=t,this.on(e,n),this},EventEmitter.prototype.removeListener=function(e,t){var n,s,i,r;if(!isFunction(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(n=this._events[e],i=n.length,s=-1,n===t||isFunction(n.listener)&&n.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(isObject(n)){for(r=i;r-->0;)if(n[r]===t||n[r].listener&&n[r].listener===t){s=r;break}if(0>s)return this;1===n.length?(n.length=0,delete this._events[e]):n.splice(s,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},EventEmitter.prototype.removeAllListeners=function(e){var t,n;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(n=this._events[e],isFunction(n))this.removeListener(e,n);else for(;n.length;)this.removeListener(e,n[n.length-1]);return delete this._events[e],this},EventEmitter.prototype.listeners=function(e){var t;return t=this._events&&this._events[e]?isFunction(this._events[e])?[this._events[e]]:this._events[e].slice():[]},EventEmitter.listenerCount=function(e,t){var n;return n=e._events&&e._events[t]?isFunction(e._events[t])?1:e._events[t].length:0};
},{}]},{},[8])
;
//# sourceMappingURL=WebP2P.io.map